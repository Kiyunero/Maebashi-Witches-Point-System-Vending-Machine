<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ËÅñÂú∞Â∑°Á§º„Éû„ÉÉ„Éó</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#343a40">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/t-flick-keyboard@1/dist/css/style.min.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <a href="https://kiyunero.github.io/Portal-App/" id="fixed-url-button"></a>

    <div id="ad-screen">
        <video id="ad-video" src="https://firebasestorage.googleapis.com/v0/b/pilgrimage-quest-app.firebasestorage.app/o/%E3%82%A6%E3%82%A3%E3%83%83%E3%83%81%E3%83%BC%E3%82%BA%E7%B8%A6%E5%8B%95%E7%94%BB.mp4?alt=media&token=a46dc108-bc30-4345-8bde-199f2214e5ad" autoplay playsinline></video>
        <div class="touch-prompt">ÁîªÈù¢„Çí„Çø„ÉÉ„ÉÅ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
    </div>

    <div id="main-content" class="hidden">
        <div id="map"></div>
        <div id="app">
            <div class="language-selector-container">
                <div class="dropdown">
                    <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        Ë®ÄË™ûÈÅ∏Êäû
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#">Êó•Êú¨Ë™û</a></li>
                        <li><a class="dropdown-item" href="#">English</a></li>
                        <li><a class="dropdown-item" href="#">‰∏≠Êñá</a></li>
                    </ul>
                </div>
            </div>

            <button id="back-to-ad-btn" class="btn btn-dark" v-show="!isEventDetailVisible && !isQuestDetailVisible && !isRewardPageVisible" @click="handleBackToAdClick">Â∫ÉÂëä„Å´Êàª„Çã</button>

            <div class="sidebar vh-100" v-show="!isRewardPageVisible">
                <div class="list-group overflow-auto">
                    <div v-if="header" class="list-header">
                        <img v-if="header.image" :src="header.image" alt="" class="header-image">
                        <div class="header-text">
                            <h5 class="header-title">{{ header.title }}</h5>
                            <p class="header-description" :class="{ 'expanded': isHeaderExpanded }">
                                {{ header.description }}
                            </p>
                            <button v-if="!isHeaderExpanded" @click="isHeaderExpanded = true" class="read-more-btn">
                                Á∂ö„Åç„ÇíË™≠„ÇÄ
                            </button>
                            <button v-else @click="isHeaderExpanded = false" class="read-more-btn">
                                Èñâ„Åò„Çã
                            </button>
                        </div>
                        
                        <div class="d-grid gap-2 p-2">
                            <button class="btn btn-info" @click="showAuthModal">
                                ‚òÖ „Çπ„Éû„Éõ„Å®ÈÄ£Êê∫„Åô„Çã
                            </button>
                             <div v-if="currentUser" class="alert alert-success mt-2 text-center">
                                ÈÄ£Êê∫‰∏≠: <span class="auth-modal-user-info">{{ currentUser.userId.substring(0, 8) }}...</span><br>
                                ‰øùÊúâ„Éû„Éù: <span class="auth-modal-user-info">{{ currentUser.points || 0 }} P</span>
                            </div>
                            
                            <button class="btn btn-warning" @click="showRewardPage">
                                üéÅ „Éû„Éù„ÅßÊôØÂìÅ‰∫§Êèõ
                            </button>
                        </div>
                    </div>

                    <a href="#" class="list-group-item list-group-item-action"
                       v-for="spot in spots"
                       :key="spot.name"
                       @click.prevent="onSpotClick(spot.name)">
                        <div class="list-item-content">
                            <div class="list-item-name">{{ spot.name }}</div>
                            <img v-if="spot.image" :src="spot.image" alt="" class="list-item-image">
                        </div>
                    </a>
                </div>
            </div>

            <transition name="slide">
                <div v-if="isEventDetailVisible" class="event-detail-overlay">
                    <div class="event-detail-header">
                        <h2 class="event-detail-spot-title">{{ currentSpotForEvents.name }}</h2>
                        <button @click="hideEventDetail" class="back-to-map-btn">Êàª„Çã</button>
                    </div>
                    <div class="event-detail-content">
                        <div v-if="currentSpotEvents.length > 0">
                            <div v-for="(event, index) in currentSpotEvents" :key="event.name" class="event-item">
                                <div class="event-text-content">
                                    <h3>{{ event.name }}</h3>
                                    <template v-if="event.image">
                                        <video v-if="isFirebaseMp4(event.image)"
                                               :ref="'eventVideo_' + index"
                                               :data-ref-name="'eventVideo_' + index"
                                               :src="event.image"
                                               class="event-video"
                                               autoplay loop playsinline muted>
                                        </video>
                                        <img v-else
                                             :src="event.image"
                                             alt=""
                                             class="event-image">
                                        </template>
                                    <p><strong>ÈñãÂÇ¨Êó•ÊôÇ:</strong> {{ event.datetime }}</p>
                                    <p><strong>Â†¥ÊâÄ:</strong> {{ event.location }}</p>
                                    <p><strong>„Ç¢„ÇØ„Çª„Çπ:</strong> {{ event.access }}</p>
                                    <p><strong>Ë©≥Á¥∞:</strong> {{ event.description }}</p>
                                </div>
                                <button v-if="event.qrcode" @click="showQrCode(event.qrcode, '„Ç¢„Éó„É™„ÅßË™≠„ÅøËæº„Çì„Åß„Ç§„Éô„É≥„Éà„Å´ÂèÇÂä†„Åó„Çà„ÅÜÔºÅ')" class="join-event-btn">
                                    ÂèÇÂä†„Åô„Çã
                                </button>
                            </div>
                        </div>
                        <div v-else class="no-event-message">
                            <p>ÁèæÂú®ÂèÇÂä†ÂèØËÉΩ„Å™„Ç§„Éô„É≥„Éà„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>
                        </div>
                    </div>
                </div>
            </transition>

            <transition name="slide">
                <div v-if="isQuestDetailVisible" class="event-detail-overlay">
                    <div class="event-detail-header">
                        <h2 class="event-detail-spot-title">„ÇØ„Ç®„Çπ„ÉàË©≥Á¥∞</h2>
                        <button @click="hideQuestDetail" class="back-to-map-btn">Êàª„Çã</button>
                    </div>
                    <div v-if="currentQuestForDetail" class="event-detail-content">
                        <div class="event-item">
                            <h3>{{ currentQuestForDetail.title }}</h3>
                            
                            <template v-if="currentQuestForDetail.image">
                                <video v-if="isFirebaseMp4(currentQuestForDetail.image)"
                                       :src="currentQuestForDetail.image"
                                       class="event-video"
                                       autoplay loop playsinline muted>
                                </video>
                                <img v-else
                                     :src="currentQuestForDetail.image"
                                     alt=""
                                     class="event-image">
                            </template>
                            <p><strong>Ôºú„ÇØ„Ç®„Çπ„ÉàË™¨ÊòéÔºû</strong><br>{{ currentQuestForDetail.description }}</p>
                            <p><strong>Ôºú„ÇØ„É™„Ç¢Êù°‰ª∂Ôºû</strong><br>{{ currentQuestForDetail.clearCondition }}</p>

                            <div class="text-center mt-4">
                                <p><strong>‚Üì„Çπ„Éû„Éõ„ÅßË™≠„ÅøËæº„Çì„Åß„ÇØ„Ç®„Çπ„ÉàÈñãÂßã‚Üì</strong></p>
                                <img :src="currentQuestForDetail.qrCodeUrl" class="quest-qr-image" alt="„ÇØ„Ç®„Çπ„ÉàÂèóÊ≥®Áî®QR„Ç≥„Éº„Éâ">
                            </div>
                        </div>
                    </div>
                </div>
            </transition>
            
            <transition name="slide">
                <div v-if="isRewardPageVisible" class="event-detail-overlay">
                    <div class="event-detail-header">
                        <h2 class="event-detail-spot-title">ÊôØÂìÅ‰∫§Êèõ</h2>
                        <div class="header-points-display">
                            ‰øùÊúâ„Éû„Éù: {{ currentUser?.points || 0 }} P
                        </div>
                        <button @click="hideRewardPage" class="back-to-map-btn">Êàª„Çã</button>
                    </div>
                    <div class="event-detail-content">
                        <div v-if="isRedeeming" class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p>‰∫§ÊèõÂá¶ÁêÜ‰∏≠„Åß„Åô...</p>
                        </div>
                        <div class="reward-grid" v-else>
                            <div v-for="reward in rewards" :key="reward.id" class="reward-item" 
                                 :class="{ 'redeemable': canRedeem(reward), 'insufficient': !canRedeem(reward) }"
                                 @click="redeemReward(reward)">
                                 <div class="reward-image-container">
                                    <img :src="reward.image" :alt="reward.name" class="reward-image">
                                 </div>
                                <div class="reward-info">
                                    <h5 class="reward-name">{{ reward.name }}</h5>
                                    <p class="reward-points">{{ reward.requiredPoints }} P</p>
                                </div>
                            </div>
                        </div>
                         <div v-if="!rewards.length && !isRedeeming" class="text-center">
                            <p>‰∫§Êèõ„Åß„Åç„ÇãÊôØÂìÅ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>
                        </div>
                    </div>
                </div>
            </transition>
            <transition name="fade">
                <div v-if="isQrModalVisible" class="qr-modal-overlay" @click="hideQrCode">
                    <div class="qr-modal-content" @click.stop>
                        <img :src="currentQrCode" alt="QR Code">
                        <p class="qr-modal-caption">{{ qrModalCaption }}</p>
                    </div>
                </div>
            </transition>
            
            <transition name="fade">
                <div v-if="isPurchaseModalVisible" class="custom-modal-overlay" @click="hidePurchaseModal">
                    <div class="custom-modal-content" @click.stop>
                        <h4 class="custom-modal-title">Ë≥ºÂÖ•ÊñπÊ≥ï„ÇíÈÅ∏Êäû</h4>
                        <p v-if="modalTargetSpot" class="custom-modal-description">
                            ÂïÜÂìÅ: {{ modalTargetSpot.goods_name }}
                        </p>
                        <div class="custom-modal-buttons">
                            <button class="btn btn-primary" @click="openLink(modalTargetSpot.normal_purchase_url)">ÈÄöÂ∏∏Ë≥ºÂÖ•</button>
                            <button class="btn btn-success" @click="openLink(modalTargetSpot.furusato_purchase_url)">„Åµ„Çã„Åï„Å®Á¥çÁ®é„ÅßË≥ºÂÖ•</button>
                        </div>
                        <button class="custom-modal-close-btn" @click="hidePurchaseModal">Èñâ„Åò„Çã</button>
                    </div>
                </div>
            </transition>

            <transition name="fade">
                <div v-if="isLodgingModalVisible" class="custom-modal-overlay" @click="hideLodgingModal">
                    <div class="custom-modal-content" @click.stop>
                        <h4 class="custom-modal-title" v-if="modalTargetSpot">{{ modalTargetSpot.name }}</h4>
                        
                        <div v-if="!selectedLodgingPlan">
                            <h5 class="custom-modal-subtitle">ÂÆøÊ≥ä„Éó„É©„É≥„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</h5>
                            <ul class="list-group">
                                <li v-for="plan in modalTargetSpot.lodging_plans" 
                                    class="list-group-item list-group-item-action"
                                    @click="selectLodgingPlan(plan)">
                                    <strong>{{ plan.name }}</strong><br>
                                    <span>ÊñôÈáë: {{ plan.price }}</span>
                                </li>
                            </ul>
                        </div>

                        <div v-else>
                             <h5 class="custom-modal-subtitle">„ÅäÊîØÊâï„ÅÑÊñπÊ≥ï„ÇíÈÅ∏Êäû</h5>
                             <p class="custom-modal-description">
                                 ÈÅ∏Êäû‰∏≠„ÅÆ„Éó„É©„É≥: <strong>{{ selectedLodgingPlan.name }}</strong>
                             </p>
                             <div class="custom-modal-buttons">
                                <button class="btn btn-primary" @click="openLink(modalTargetSpot.normal_payment_url)">ÈÄöÂ∏∏ÊîØÊâï</button>
                                <button class="btn btn-success" @click="openLink(modalTargetSpot.furusato_payment_url)">„Åµ„Çã„Åï„Å®Á¥çÁ®é„ÅßÊîØÊâï</button>
                             </div>
                             <button class="btn btn-link mt-3" @click="selectedLodgingPlan = null">‚Üê „Éó„É©„É≥ÈÅ∏Êäû„Å´Êàª„Çã</button>
                        </div>

                        <button class="custom-modal-close-btn" @click="hideLodgingModal">Èñâ„Åò„Çã</button>
                    </div>
                </div>
            </transition>

            <transition name="fade">
                <div v-if="isAuthModalVisible" class="custom-modal-overlay" @click="hideAuthModal">
                    <div class="custom-modal-content auth-modal-content" @click.stop>
                         <button class="custom-modal-close-btn" @click="hideAuthModal"></button>
                        <h4 class="custom-modal-title">„Çπ„Éû„Éõ„Å®ÈÄ£Êê∫</h4>
                        <p class="custom-modal-description">
                            „Çπ„Éû„Éõ„Ç¢„Éó„É™„ÅßÁô∫Ë°å„Åï„Çå„Åü6Ê°Å„ÅÆÂêàË®ÄËëâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
                        </p>
                        
                        <input type="text" class="form-control auth-modal-input" v-model="enteredAuthToken" maxlength="6">
                        
                        <div class="d-grid">
                            <button class="btn btn-primary btn-lg" @click="loginWithAuthToken" :disabled="isTokenLoading">
                                <span v-if="isTokenLoading" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                ÈÄ£Êê∫„Åô„Çã
                            </button>
                        </div>
                        <div v-if="authErrorMessage" class="mt-3 alert alert-danger">
                            {{ authErrorMessage }}
                        </div>
                    </div>
                </div>
            </transition>

            </div>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyACAVYO9bza32V-dYFaiRafHn8owtIw3eg&callback=initMap" defer></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="js/main.js"></script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js').then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }).catch(err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
    </body>
</html>